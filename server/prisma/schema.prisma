generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           Int           @id @default(autoincrement())
  name         String
  email        String        @unique
  password     String
  role         Role          @default(USER)
  userPlans    UserPlan[]
  totalInvested Float        @default(0)
  currentValue  Float        @default(0)
  active       Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  transactions Transaction[]
  holdings     Holding[]
  invoices     Invoice[]
  paymentMethods PaymentMethod[]
  tickets      Ticket[]

  // Security & Account Recovery
  isEmailVerified          Boolean   @default(false)
  emailVerificationToken   String?   @unique
  resetPasswordToken       String?   @unique
  resetPasswordExpires     DateTime?
}

model Plan {
  id             Int      @id @default(autoincrement())
  name           String   @unique
  minInvestment  Float
  roiLow         String   @default("5-8%")
  roiMedium      String   @default("8-12%")
  roiHigh        String   @default("12-18%")
  duration       String
  description    String
  features       String[]
  popular        Boolean  @default(false)
  active         Boolean  @default(true)
  color          String   @default("#0a7c42")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  userPlans      UserPlan[]
}

model UserPlan {
  id            Int      @id @default(autoincrement())
  userId        Int
  planId        Int
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan          Plan     @relation(fields: [planId], references: [id], onDelete: Cascade)
  amount        Float    // Dynamic amount user invested into this specific plan
  riskLevel     String   // Low, Medium, High
  status        String   @default("ACTIVE")
  
  // Pending modifications wait for the next ROI cycle to activate
  pendingAmount    Float?
  pendingRiskLevel String?

  createdAt     DateTime @default(now())
  
  @@unique([userId, planId])
}

model Transaction {
  id          Int      @id @default(autoincrement())
  userId      Int
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        TxType
  amount      Float
  description String
  status      TxStatus @default(COMPLETED)
  date        DateTime @default(now())
  createdAt   DateTime @default(now())
  invoiceId   Int?
  invoice     Invoice? @relation(fields: [invoiceId], references: [id])
}

model Holding {
  id     Int    @id @default(autoincrement())
  userId Int
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  name   String
  amount Float
  roi    Float  @default(0)
  change String @default("+0.0%")
  status String @default("active")
}

model Invoice {
  id             Int           @id @default(autoincrement())
  invoiceNumber  String        @unique
  userId         Int
  user           User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  month          String
  year           Int
  planName       String
  investedAmount Float
  roiPercentage  Float
  returnAmount   Float
  status         String        @default("PAID")
  note           String?
  issuedAt       DateTime      @default(now())
  transactions   Transaction[]
}

model SiteContent {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     String
  section   String
  updatedAt DateTime @updatedAt
}

model PaymentMethod {
  id            Int      @id @default(autoincrement())
  userId        Int
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type          String   // BANK, MOBILE, CRYPTO
  provider      String   // Bank Name, bKash, Nagad, USDT, etc
  accountName   String   // Name on account
  accountNumber String   // Bank Acct #, Phone Mobile #, Wallet Address
  
  // Specific to Bank Accounts
  branchName    String?
  routingNumber String?
  swiftCode     String?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Ticket {
  id          Int          @id @default(autoincrement())
  userId      Int
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  subject     String
  message     String
  attachment  String?
  status      TicketStatus @default(OPEN)
  adminReply  String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

enum Role {
  USER
  ADMIN
}

enum TxType {
  DEPOSIT
  RETURN
  WITHDRAWAL
}

enum TxStatus {
  PENDING
  COMPLETED
  REJECTED
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}
